<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Classic Cut</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --bg-dark: #121212;
            --bg-card: #1E1E1E;
            --gold: #D4AF37;
            --text: #E0E0E0;
            --success: #03DAC6;
            --danger: #CF6679;
        }

        * { box-sizing: border-box; }
        body { font-family: 'Roboto', sans-serif; background: var(--bg-dark); color: var(--text); margin: 0; padding-bottom: 80px; }
        
        /* --- HEADER --- */
        header {
            background: linear-gradient(rgba(0,0,0,0.üòé, rgba(0,0,0,0.8)), url('https://images.unsplash.com/photo-1585747860715-2ba37e788b70');
            background-size: cover;
            background-position: center;
            padding: 3rem 1rem;
            text-align: center;
            border-bottom: 3px solid var(--gold);
        }
        h1 { font-family: 'Playfair Display', serif; color: var(--gold); margin: 0; text-transform: uppercase; letter-spacing: 1px; font-size: 2rem; }
        
        /* --- CONTAINER --- */
        .container { max-width: 600px; margin: 0 auto; padding: 1.5rem; }
        
        /* --- INPUTS & BUTTONS --- */
        select, input { width: 100%; padding: 14px; background: var(--bg-card); border: 1px solid #333; border-radius: 4px; color: white; font-size: 1rem; margin-bottom: 15px; }
        option.main-barber { color: var(--success); font-weight: bold; background: #1a332f; }

        .btn-submit { background: var(--gold); color: black; font-weight: bold; border: none; padding: 15px; width: 100%; border-radius: 50px; font-size: 1.1rem; cursor: pointer; text-transform: uppercase; margin-top: 10px; }
        .btn-submit:disabled { opacity: 0.5; }

        /* --- CALENDAR --- */
        .calendar-wrapper { background: var(--bg-card); border: 1px solid #333; border-radius: 8px; padding: 10px; text-align: center; margin-bottom: 15px; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .calendar-btn { background: none; border: 1px solid #555; color: white; padding: 5px 10px; cursor: pointer; border-radius: 4px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .day-num { padding: 10px; cursor: pointer; border-radius: 4px; font-size: 0.9rem; }
        .day-num:hover { background: #333; }
        .day-num.selected { background: var(--gold); color: black; font-weight: bold; }
        .day-num.disabled { color: #444; pointer-events: none; }

        /* --- ADMIN DASHBOARD --- */
        .admin-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; margin-top: 10px; }
        .admin-table th { text-align: left; color: #888; padding: 10px 5px; border-bottom: 1px solid #444; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; }
        .admin-table td { padding: 15px 5px; border-bottom: 1px solid #333; vertical-align: top; }
        
        /* Badges & Buttons */
        .status-badge { padding: 3px 6px; border-radius: 3px; font-size: 0.75rem; display: inline-block; margin-top: 5px; }
        .status-Confirmed { background: rgba(3, 218, 198, 0.2); color: var(--success); }
        .status-Pending { background: rgba(255, 255, 255, 0.1); color: #aaa; }
        .status-Rejected { text-decoration: line-through; color: var(--danger); opacity: 0.7; }

        .action-btn { border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; margin-right: 5px; color: white; font-size: 1rem; }
        .btn-ok { background: #1b5e20; } 
        .btn-no { background: #b71c1c; }

        .barber-list-item { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #333; align-items: center; }
        .barber-list-item button { background: var(--danger); border: none; color: white; border-radius: 4px; padding: 5px 10px; cursor: pointer; }

        /* Floating Footer */
        .bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-card); padding: 15px; border-top: 1px solid #333; z-index: 99; }
    </style>
</head>
<body>

    <div id="clientView">
        <header>
            <h1>The Classic Cut</h1>
            <p style="color:#aaa; font-size:0.9rem; margin-top:5px;">Book Your Appointment</p>
        </header>

        <div class="container">
            <form id="bookForm">
                <label style="color:var(--gold); font-size:0.8rem; display:block; margin-bottom:5px; letter-spacing:1px;">SELECT BARBER</label>
                <select id="barber" required onchange="checkAvailability()">
                    <option value="" disabled selected>Loading Barbers...</option>
                </select>

                <label style="color:var(--gold); font-size:0.8rem; display:block; margin-bottom:5px; letter-spacing:1px;">SELECT DATE</label>
                <div class="calendar-wrapper">
                    <div class="calendar-header">
                        <button type="button" class="calendar-btn" onclick="changeMonth(-1)">&#10094;</button>
                        <span id="monthYear" style="color:var(--gold); font-weight:bold;"></span>
                        <button type="button" class="calendar-btn" onclick="changeMonth(1)">&#10095;</button>
                    </div>
                    <div class="calendar-grid" id="calendarDays"></div>
                </div>
                <input type="hidden" id="date" required>

                <label style="color:var(--gold); font-size:0.8rem; display:block; margin-bottom:5px; letter-spacing:1px;">TIME SLOT</label>
                <select id="time" required>
                    <option value="" disabled selected>Select Date First...</option>
                    <option value="07:30 AM">07:30 AM - 08:15 AM</option>
                    <option value="08:15 AM">08:15 AM - 09:00 AM</option>
                    <option value="09:00 AM">09:00 AM - 09:45 AM</option>
                    <option value="09:45 AM">09:45 AM - 10:30 AM</option>
                    <option value="10:30 AM">10:30 AM - 11:15 AM</option>
                    <option value="11:15 AM">11:15 AM - 12:00 PM</option>
                    <option value="12:30 PM">12:30 PM - 01:15 PM</option>
                    <option value="01:15 PM">01:15 PM - 02:00 PM</option>
                    <option value="02:00 PM">02:00 PM - 02:45 PM</option>
                    <option value="02:45 PM">02:45 PM - 03:30 PM</option>
                    <option value="03:30 PM">03:30 PM - 04:15 PM</option>
                    <option value="04:15 PM">04:15 PM - 05:00 PM</option>
                </select>

                <div style="margin-top:30px;">
                    <label style="color:var(--gold); font-size:0.8rem; display:block; margin-bottom:5px; letter-spacing:1px;">YOUR DETAILS</label>
                    <input type="text" id="name" placeholder="Full Name" required>
                    <input type="tel" id="phone" placeholder="Mobile Number" required>
                    <input type="email" id="email" placeholder="Email Address" required>
                </div>

                <div id="message" style="display:none; text-align:center; padding:15px; margin-bottom:10px; border-radius:5px;"></div>
                <div style="height:80px;"></div> <div class="bottom-bar">
                    <button type="submit" class="btn-submit" id="submitBtn">Confirm Booking</button>
                </div>
            </form>

            <div style="text-align:center; margin-top:30px; opacity:0.5; padding-bottom:30px;">
                <a href="#" onclick="loginAdmin()" style="color:white; text-decoration:none; font-size:0.8rem;">üîí Admin Login</a>
            </div>
        </div>
    </div>

    <div id="adminPanel" style="display:none;" class="container">
        <header style="padding:1.5rem;">
            <h1>Admin Dashboard</h1>
            <button onclick="logoutAdmin()" style="background:none; border:1px solid var(--gold); color:var(--gold); padding:5px 15px; margin-top:10px; cursor:pointer; border-radius:20px;">Logout</button>
        </header>

        <div style="background:var(--bg-card); padding:20px; border-radius:8px; margin-bottom:30px; border:1px solid #333;">
            <h3 style="margin:0 0 15px 0; color:var(--gold); border-bottom:1px solid #333; padding-bottom:10px;">Manage Barbers</h3>
            <div style="display:flex; gap:10px;">
                <input type="text" id="newBarberName" placeholder="Barber Name" style="margin:0;">
                <button onclick="addBarber()" style="background:var(--success); color:black; border:none; padding:0 20px; font-weight:bold; cursor:pointer; border-radius:4px;">ADD</button>
            </div>
            <div id="barberList" style="margin-top:15px;">Loading...</div>
        </div>

        <h3 style="color:var(--gold); border-bottom:1px solid #333; padding-bottom:10px;">Bookings</h3>
        <div id="adminLoading" style="text-align:center; padding:20px; color:#666;">Updating...</div>
        
        <table class="admin-table">
            <thead>
                <tr>
                    <th style="width:30%">Date & Time</th>
                    <th style="width:40%">Details</th>
                    <th style="width:30%">Action</th>
                </tr>
            </thead>
            <tbody id="bookingList"></tbody>
        </table>
    </div>

<script>
    // ‚ö†Ô∏è PASTE YOUR GOOGLE SCRIPT URL HERE ‚ö†Ô∏è
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxK-9uPyXJvBglEvqbpvhvGM4EOzZDqJf8OZsqPcHX7fRE8SwIyg0YKmnLOf5uHubx8/exec';
    
    // --- INITIALIZATION ---
    window.onload = function() {
        renderCalendar();
        loadBarbers(); 
        
        // Auto-Login if session exists
        if (sessionStorage.getItem('adminLogged') === 'true') {
            openAdminPanel(sessionStorage.getItem('adminPass'), false); 
        }
    };

    // ================= CLIENT FUNCTIONS =================

    function loadBarbers() {
        fetch(SCRIPT_URL + '?action=getBarbers')
        .then(res => res.json())
        .then(data => {
            const select = document.getElementById('barber');
            select.innerHTML = '<option value="" disabled selected>Select Barber...</option>';
            
            if (!Array.isArray(data)) { 
                addOption(select, "John Francis Romias"); 
                return; 
            }
            
            let validCount = 0;
            data.forEach(item => {
                // --- THE NUCLEAR FILTER ---
                let name = "";
                if (item && item.name) name = item.name;
                else if (Array.isArray(item)) name = item[0];
                else name = String(item);

                let cleanName = String(name).trim();
                
                // Block bad data
                if (cleanName === "" || 
                    cleanName.toLowerCase() === "undefined" || 
                    cleanName.toLowerCase() === "null" || 
                    cleanName === "Name") return;

                addOption(select, cleanName);
                validCount++;
            });

            // Fallback if empty
            if(validCount === 0) addOption(select, "John Francis Romias");

            // If Admin panel is already open, update that list too
            if(document.getElementById('adminPanel').style.display === 'block') renderAdminBarberList(data);
        })
        .catch(err => {
            const select = document.getElementById('barber');
            addOption(select, "John Francis Romias");
        });
    }

    function addOption(select, name) {
        const opt = document.createElement('option');
        opt.value = name;
        if (name === "John Francis Romias") {
            opt.innerHTML = "‚≠ê John Francis Romias (Main)";
            opt.className = "main-barber";
        } else {
            opt.innerText = name;
        }
        select.appendChild(opt);
    }

    // --- CALENDAR LOGIC ---
    let currentDate = new Date();
    function renderCalendar() {
        const grid = document.getElementById("calendarDays"); 
        grid.innerHTML = "";
        const m = currentDate.getMonth(), y = currentDate.getFullYear();
        document.getElementById("monthYear").innerText = new Date(y, m).toLocaleString('default', { month: 'long', year: 'numeric' });
        
        const firstDay = new Date(y, m, 1).getDay();
        const daysInMonth = new Date(y, m + 1, 0).getDate();
        
        for(let i=0; i<firstDay; i++) grid.appendChild(document.createElement("div"));
        
        const today = new Date(); today.setHours(0,0,0,0);
        for(let i=1; i<=daysInMonth; i++) {
            let d = document.createElement("div"); 
            d.className = "day-num"; 
            d.innerText = i;
            let dateStr = new Date(y, m, i).toISOString().split('T')[0];
            
            if (new Date(y, m, i) < today) {
                d.classList.add("disabled");
            } else {
                d.onclick = () => {
                    document.querySelectorAll(".day-num").forEach(x => x.classList.remove("selected"));
                    d.classList.add("selected");
                    document.getElementById("date").value = dateStr;
                    checkAvailability();
                };
            }
            grid.appendChild(d);
        }
    }
    function changeMonth(d) { currentDate.setMonth(currentDate.getMonth() + d); renderCalendar(); }

    function checkAvailability() {
        let date = document.getElementById('date').value;
        let barber = document.getElementById('barber').value;
        let timeSelect = document.getElementById('time');
        
        if (!date || !barber) return;

        timeSelect.disabled = true; 
        timeSelect.options[0].text = "Checking...";
        
        [...timeSelect.options].forEach(o => { 
            o.disabled = false; 
            o.innerText = o.value.replace('‚ùå ', '').replace(' (Booked)', ''); 
        });

        fetch(${SCRIPT_URL}?date=${date}&barber=${encodeURIComponent(barber)})
        .then(res => res.json())
        .then(booked => {
            timeSelect.disabled = false; 
            timeSelect.options[0].text = "Select Time Slot";
            
            if(Array.isArray(booked)) {
                [...timeSelect.options].forEach(o => {
                    if(booked.includes(o.value)) { 
                        o.disabled = true; 
                        o.innerText = "‚ùå " + o.value; 
                    }
                });
            }
        });
    }

    document.getElementById('bookForm').addEventListener('submit', e => {
        e.preventDefault();
        let btn = document.getElementById('submitBtn');
        let msg = document.getElementById('message');
        btn.disabled = true; btn.innerText = "Processing...";
        
        let fd = new FormData();
        fd.append('barber', document.getElementById('barber').value);
        fd.append('date', document.getElementById('date').value);
        fd.append('time', document.getElementById('time').value);
        fd.append('name', document.getElementById('name').value);
        fd.append('email', document.getElementById('email').value);
        fd.append('phone', document.getElementById('phone').value);

        fetch(SCRIPT_URL, {method:'POST', body:fd})
        .then(res=>res.json())
        .then(d=>{
            btn.disabled = false; 
            btn.innerText = "Confirm Booking";
            msg.style.display = 'block';
            
            if(d.result==='success') {
                msg.style.background = 'rgba(3, 218, 198, 0.2)'; 
                msg.style.color = '#03DAC6';
                msg.innerHTML = "‚úÖ Booking Confirmed!";
                document.getElementById('bookForm').reset();
                document.querySelectorAll(".day-num").forEach(x => x.classList.remove("selected"));
                checkAvailability();
            } else {
                msg.style.background = 'rgba(207, 102, 121, 0.2)'; 
                msg.style.color = '#CF6679';
                msg.innerHTML = "‚ùå " + d.message;
            }
        });
    });

    // ================= ADMIN FUNCTIONS =================
    
    let refreshTimer = null;

    function loginAdmin() { 
        let pass = prompt("Enter Password:"); 
        if(pass) openAdminPanel(pass, true); 
    }

    function openAdminPanel(pass, isLoginAttempt) {
        fetch(${SCRIPT_URL}?action=getAdminData&password=${pass})
        .then(res => res.json())
        .then(data => {
            if (data.result === 'error') {
                if (isLoginAttempt) alert("‚ùå " + data.message);
                return;
            }
            // Login Success
            sessionStorage.setItem('adminLogged', 'true');
            sessionStorage.setItem('adminPass', pass);
            
            document.getElementById('clientView').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            
            renderAdminTable(data);
            
            // Fetch Barber List for Admin
            fetch(SCRIPT_URL + '?action=getBarbers').then(r=>r.json()).then(d => {
                 if(Array.isArray(d)) renderAdminBarberList(d);
            });

            // Start Auto-Refresh (5 seconds)
            if(refreshTimer) clearInterval(refreshTimer);
            refreshTimer = setInterval(() => {
                fetch(${SCRIPT_URL}?action=getAdminData&password=${pass})
                .then(r=>r.json()).then(d => { if(Array.isArray(d)) renderAdminTable(d); });
            }, 5000);
        });
    }

    function logoutAdmin() { 
        sessionStorage.clear(); 
        location.reload(); 
    }

    function renderAdminTable(data) {
        document.getElementById('adminLoading').style.display = 'none';
        let html = "";
        
        if(!data || data.length === 0) {
            html = "<tr><td colspan='3' style='text-align:center; padding:20px; color:#555;'>No bookings yet.</td></tr>";
        } else {
            data.forEach(b => {
                // b.date is now "Feb 14 (Sat)" from the server
                html += `<tr>
                    <td>
                        <div style="font-weight:bold; font-size:1.1rem; color:#fff;">${b.date}</div>
                        <div style="color:var(--gold); font-size:0.95rem;">${b.time}</div>
                    </td>
                    <td>
                        <div style="font-weight:bold; font-size:1rem;">${b.name}</div>
                        <div style="font-size:0.85rem; color:#aaa; margin-top:2px;">üíà ${b.barber}</div>
                        <div style="font-size:0.8rem; color:#666; margin-top:2px;">üìû ${b.phone}</div>
                        <span class="status-badge status-${b.status}">${b.status}</span>
                    </td>
                    <td>
                        ${b.status !== 'Rejected' ? `
                        <button class="action-btn btn-ok" onclick="updateStatus(${b.row}, 'Confirmed')">‚úî</button>
                        <button class="action-btn btn-no" onclick="updateStatus(${b.row}, 'Rejected')">‚úñ</button>
                        ` : ''}
                    </td>
                </tr>`;
            });
        }
        document.getElementById('bookingList').innerHTML = html;
    }

    function updateStatus(row, status) {
        if(!confirm("Change status to " + status + "?")) return;
        
        // Optimistic UI update (fade table)
        document.getElementById('bookingList').style.opacity = '0.5';
        
        let fd = new FormData();
        fd.append('action', 'updateStatus');
        fd.append('password', sessionStorage.getItem('adminPass'));
        fd.append('row', row);
        fd.append('status', status);
        
        fetch(SCRIPT_URL, {method:'POST', body:fd})
        .then(r=>r.json())
        .then(d=>{
            alert(d.result === 'success' ? "Updated!" : "Error");
            document.getElementById('bookingList').style.opacity = '1';
            
            // Force immediate refresh
            let pass = sessionStorage.getItem('adminPass');
            fetch(${SCRIPT_URL}?action=getAdminData&password=${pass})
            .then(r=>r.json()).then(d => renderAdminTable(d));
        });
    }

    function renderAdminBarberList(data) {
        let html = "";
        data.forEach(item => {
             let name = "";
             if (item && item.name) name = item.name;
             else if (Array.isArray(item)) name = item[0];
             else name = String(item);
             
             let cleanName = String(name).trim();
             // Filter for Admin list
             if (cleanName === "" || cleanName.toLowerCase() === "undefined" || cleanName.toLowerCase() === "null" || cleanName === "Name") return;

            html += `<div class="barber-list-item">
                <span>${cleanName}</span>
                ${cleanName !== "John Francis Romias" ? <button onclick="deleteBarber('${cleanName}')">DELETE</button> : '<span style="color:var(--success); font-size:0.8em;">(Locked)</span>'}
            </div>`;
        });
        document.getElementById('barberList').innerHTML = html;
    }

    function addBarber() {
        let name = document.getElementById('newBarberName').value;
        if(!name) return;
        
        // Show temp saving state
        let list = document.getElementById('barberList');
        list.innerHTML += <div style="padding:10px; color:var(--gold);">Saving ${name}...</div>;
        
        let fd = new FormData();
        fd.append('action', 'addBarber');
        fd.append('password', sessionStorage.getItem('adminPass'));
        fd.append('name', name);
        
        fetch(SCRIPT_URL, {method:'POST', body:fd})
        .then(r=>r.json())
        .then(d=>{
            document.getElementById('newBarberName').value = "";
            fetch(SCRIPT_URL + '?action=getBarbers').then(r=>r.json()).then(d => { if(Array.isArray(d)) renderAdminBarberList(d); });
        });
    }

    function deleteBarber(name) {
        if(!confirm("Delete " + name + "?")) return;
        
        let fd = new FormData();
        fd.append('action', 'deleteBarber');
        fd.append('password', sessionStorage.getItem('adminPass'));
        fd.append('name', name);
        
        fetch(SCRIPT_URL, {method:'POST', body:fd})
        .then(r=>r.json())
        .then(d=>{
            fetch(SCRIPT_URL + '?action=getBarbers').then(r=>r.json()).then(d => { if(Array.isArray(d)) renderAdminBarberList(d); });
        });
    }
</script>
</body>
</html>
